---
title: "ETC5521 Assignment 1"
subtitle: "House and Mortgage Data"
team: Dugong
author:
  - Abhishek Sinha
  - Yezi He
  - Yawen Zhang
  - Cuiping Wei
# output: 
#   bookdown::html_document2
bibliography: reference.bib
biblio-style: authoryear-comp
link-citations: yes
linestretch: 3
date: "`r Sys.Date()`"
output: 
  bookdown::html_document2: 
    toc: yes
    toc_float:
      collapsed: true
      number_sections: false
    theme: paper
---

[This assignment is for ETC5521 Assignment 1 by Team `r rmarkdown::metadata$team` comprising of `r knitr::combine_words(rmarkdown::metadata$author)`.]{style="color:#006DAE;"}

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,warning = FALSE,message = FALSE)
library(tidyverse)
library(scales)
library(lubridate)
library(broom)
library(MASS)
library(stringr)
library(kableExtra)
library(readxl)
library(janitor)
library(rvest)
library(dplyr)
library(plotly)
```

```{r write-data}
# state_hpi <- readr::read_csv("https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2019/2019-02-05/state_hpi.csv")
# mortgage_rates <- readr::read_csv("https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2019/2019-02-05/mortgage.csv")
# recession_dates <- readr::read_csv("https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2019/2019-02-05/recessions.csv")

# write_csv(state_hpi, here::here("data", "state_hpi.csv"))
# write_csv(mortgage_rates, here::here("data", "mortgage_rates.csv"))
# write_csv(recession_dates, here::here("data", "recession_dates.csv"))
```

```{r read-data}
state_hpi <-readr::read_csv(here::here("data/state_hpi.csv")) 
mortgage_rates<-readr::read_csv(here::here("data/mortgage_rates.csv")) 
recession_dates<-readr::read_csv(here::here("data/recession_dates.csv")) 
```

# Data Description and Limitations: 
The data which are used for analyzing in this report are from GitHub which contains house and mortgage data. The original source can be found from the Freddie Mace House Price Index at State and National level and Wikipedia. There will be three data sets to do the analysis. 
  
The first table is related to the House Price Index (HPI) in each state. @HPI is a broad measure of the movement of single-family house prices between January 1975 and the end of the most recent index month. It is covering index values are available for the national, the 50 states and the District of Columbia, and the more than 380 metropolitan statistical areas (MSAs) in the U.S. The whole data structure displays as follows. 

|Variable    |Class     |Description |
|:---|:---|:-----------|
|year        |date - integer   |      Year      |
|month       |date - integer   |    Month        |
|state       |character |   US State         |
|price_index |double    |   Calculated House Price Index - average price changes in repeat sales or refinancings at state level         |
|us_avg      |double    |   Calculated House Price Index - averaged at national level         |


The second data set is related to *Freddie Mac’s Mortgage rates*. Mortgage rates are an important factor that can influence the home buyer's decision which refers to homebuyers looking to finance a new home purchase with a mortgage loan. Freddie Mac maintains an extensive data set for mortgage rates consisting of different types of mortgage like ‘Fixed rate 30-year mortgage’, ‘Fixed rate 15-year mortgage’ and ‘5-1 Hybrid Adjustable rate mortgage’. One thing needs to notice that 30-year fixed rate begin in 1971, while the 15-year data goes back in 1991 and the adjustable 5-1 Hybrid begins in 2005. The whole data structure also present as follows. 

|Variable                              |Class  |Description |
|:-----------|:---|:-----------|
|date                                  |date |     Date       |
|fixed_rate_30_yr                      |double |     Fixed rate 30 year mortgage (percent)       |
|fees_and_pts_30_yr                    |double |      Fees and percentage points of the loan amount      |
|fixed_rate_15_yr                      |double |     Fixed rate 15 year mortgage (percent)       |
|fees_and_pts_15_yr                    |double |      Fees and percentage points of the loan amount      |
|adjustable_rate_5_1_hybrid            |double |      5-1 Hybrid Adjustable rate mortgage (5 year fixed, then annual adjustable rate)     |
|fees_and_pts_5_1_hybrid               |double |     Fees and percentage points of the loan amount       |
|adjustable_margin_5_1_hybrid          |double |      A fixed amount added to the underlying index to establish the fully indexed rate for an ARM.|
|spread_30_yr_fixed_and_5_1_adjustable |double |      Difference in rate between 30 year fixed and 5-1 adjustable      |


The final data set concludes all the recession dates and information from Wikipedia in U.S. These periods of recession have a significant impact on the U.S. economy. These events may affect many industries and markets and are an important factor in analyzing the house prices overtime. Recession can slow down the market, increase unemployment which leads to loss of income and falling wages which ultimately reduces the spending power of potential home buyers.  There have been 14 noteworthy recessions throughout U.S. history, including the Great Depression. The brief structure of this data will show as follows. 

|Variable                             |Class     |Description |
|:-----------|:---|:-----------|
|name                                 |character |    Recession Name        |
|period_range                         |character |        Time period range of the recession    |
|duration_months                      |character |      How long the recession lasted      |
|time_since_previous_recession_months |character |    Time since previous recession in months        |
|peak_unemploy_ment                   |character |  Peak unemployment (percent)          |
|gdp_decline_peak_to_trough           |character |     GDP decline from peak to trough       |
|characteristics                      |character |  Paragraph description of the recession          |

Furthermore, there are some limitations regarding these three data sets. In this report, we will use some built in R datasets such as state region and state name. The built in R dataset only contains 50 states of U.S., Alaska state will not include in our analysis. And the map will not present the Alaska state.


# Exploration Data Analysis

## How similar is the change in state HPI with national HPI?
The first question focus on the changes between state HPI and national HPI. As the national HPI is driven by the states, it is necessary to look at which states are the driving force behind it and which states are struggling. However, to analyse the HPI values across 51 states is quite an arduous approach. This prompted an idea to instead look at the regions and compare it with national values. We use a built-in data set called ‘state.region’ to divided each state into four regions.
  
The Figure \@ref(fig:region-wise) presents four regions across the U.S. and how the HPI values at the state level compare with the national level. It is obvious to see that the West and Northeast regions are relatively on the same path as national HPI. In some cases, these two regions are slightly higher than the national level. The countries represented by these regions are California in West and New York or Connecticut in Northeast. California continues to lead the tech industries in recent years (@California). For Regions like South and North Central which are comparatively lower than national changes. It may due to the location and less population. We noticed that they also witnessed a gradual increase in HPI but the effect of housing bubble and great recession was less drastic. 

```{r wrangle}
mortgage_rates_month <-  mortgage_rates %>%
  mutate(year = year(date), month = month(date)) %>%
  dplyr::select("date","year","month","fixed_rate_30_yr") %>%
  group_by(year,month) %>%
  summarise("fixed_rate_30_yr" = mean(fixed_rate_30_yr))

state_hpi <- state_hpi %>% 
  mutate(date = ymd(year*10000+month*100+1)) 

nation_hpi <- state_hpi %>%
  dplyr::select("date","year","month","us_avg") %>%
  distinct()

```

```{r region-wise, fig.cap="Compare US Four Regions with the Natinal Level"}
state_abb <- as.data.frame(state.abb)
state_abb <- state_abb %>% 
  mutate(region = state.region)
colnames(state_abb)[1] <- "state"

state_hpi_abb <- merge(x=state_hpi, y=state_abb, by="state", all.x = TRUE)
state_hpi_abb$region[is.na(state_hpi_abb$region)] <- "South"

state_data_hpi <- state_hpi_abb %>% 
  select("date", "region", "state", "price_index", "us_avg") %>% 
  group_by(date,region,us_avg) %>% 
  summarise(price_index = median(price_index)) %>%
  rename("National_HPI" = "us_avg", "State_HPI" = "price_index")

p1 <- state_data_hpi %>%
  ggplot()+ 
  geom_line(data=state_data_hpi, aes(x=date, y=State_HPI, color="red")) +
  geom_line(data=state_data_hpi, aes(x=date, y=National_HPI, color="green")) + 
  facet_wrap( ~ region) +
  xlab("Year") +
  ylab("HPI") +
  ggtitle("US Region vs. Average HPI") +
  scale_colour_discrete(labels = c('National','State')) +
  guides(color=guide_legend(title=NULL)) +
  theme_bw()
p1

# ggplotly(p1)
```

## Do lower mortgage rates mean higher HPI? Can the long mortgage rates predict HPI?

The second sub question looks at the effect of Mortgage rates on HPI. Mortgage rates and HPI are two separate entities which are calculated on different parameters, but their relations can give interesting insights. For our analysis, we focus on the ‘fixed 30 years rate’ mortgage, as this is more popular within US home-buyers’ markets and has offered a completed picture since the mortgage rate begins. 
  
In the short term, the factors that affecting mortgage rate and house price are different. Mortgage rates can indirectly affect home prices. To be specific, the mortgage rate trend to decrease when the economics is poor, the market is relative unhealthy and wages are decreasing. A major factor causing home prices to rise is a shortage of entry-level construction (@price). Since building material is rising in cost, constrictor more willing to invest the building cost in high-end properties. Intense competition for entry-level homes will lead to higher prices.
  
In Figure \@ref(fig:hpi-mort), we can notice that the House Price Index increased overtime, surprisingly mortgage rates have come crashing down from 1971 to 2018. It indicates that there is a strong relationship that higher rates will lead to a drop-in home price in the long term. This situation follows a simple economics situation, as the economics get better, people have more money to buy houses. As people buy homes using mortgages most of the time, this means that financing houses has become easier. This indicates that the bank has enough reserves to dish out mortgage loans at such low rates. Then, house demand will become higher, which will eventually lead to housing prices increase. Therefore, in the long term, we could use the changes in mortgage rates to predict HPI. 
Figure \@ref(fig:relationship) also could indicates that the correlation is -0.792, the mortgage rates and HPI have strong negative relationships. 


```{r hpi-mort, fig.cap="The changes between Mortgage rates and HPI"}
# national HPI
hpi_mort <- ggplot()+ 
  geom_line(data=mortgage_rates, 
            aes(x=date, y=fixed_rate_30_yr*10),
            color = "#A73737",
            size = 0.8) +
  geom_line(data=nation_hpi, 
            aes(x=date, y=us_avg),
            color="#7A9D96", 
            size = 0.8)+
  scale_y_continuous(sec.axis = sec_axis(~ . *0.1, name = "Mortgage Rates"))+
  xlim(ymd(19750101), NA) +
  labs(x="Date", y="US Average HPI") +
  ggtitle("The Changes between Mortgage rates and HPI") 
  
hpi_mort 
```


```{r relationship, fig.cap="The relationship between HPI and Mortgage rate"}
mortgage_date <- unite(data = mortgage_rates_month, date, sep = "-", year, month)
nation_date <- unite(data = nation_hpi, date, sep = "-", year, month)

HPI_mortgage <- mortgage_date %>%
  full_join(nation_date, by = "date") %>%
  rename("Mortgage Rate" = fixed_rate_30_yr, "House Pricing Index (HPI)" = us_avg)

GGally::ggpairs(HPI_mortgage ,c(2:3))+
  theme_bw()+
  theme(panel.grid.major = element_blank(), 
        panel.border = element_rect(linetype = "dashed", 
                                    colour = "#8E9EAB", 
                                    fill = NA)) +
  ggtitle("The Relationship between Mortgage Rate and Hpi")


# twoord.plot(lx = HPI_mortgage$date, ly = HPI_mortgage$us_avg, rx = HPI_mortgage$date, ry = HPI_mortgage$fixed_rate_30_yr, main = "House Price vs. Mortgage Rate", xlab = "Date", ylab = "Mortgage Rate", rylab = "HPI", type=c('line','line'))
```

## Are HPI more likely to be higher in prosperous or populous cities?
This part aims to answer the question: Are HPI more likely to be higher in prosperous or populous cities? Since the time interval of the original data is extremely long, calculate the average HPI from 1975 to 2018 has some limitations. Therefore, selecting the data for the latest 10 years could answer this question more accurately. The following Figure \@ref(fig:map-HPI) used the shade of color to represent the HPI. Dark red area indicates higher HPI and vice verse. Within the whole area, the darkest state is ND (State of North Dakota) which reached to 180 percent of HPI. Although we could not conclude HPI may be higher in prosperous region, the HPI in western and eastern coastal area is higher than inland area. On the map, the coastal states of U.S is darker than inland areas especially near California and capital region. 

```{r filter-2008-2018}
# US map
states <- map_data("state")
state.abb <- as.data.frame(state.abb)
state.name <- as_data_frame(state.name)
USstate <- cbind(state.abb, state.name) %>%
  rename(state = state.abb, full_name = value)

# Average HPI in each state
avg_state <- state_hpi %>%
  filter(year %in% c("2008","2009","2010","2011","2012", "2013", "2014", "2015", "2016", "2017", "2018")) %>%
  group_by(state) %>%
  summarise(mean = mean(price_index)) %>%
  ungroup()

join <- avg_state %>%
  right_join(USstate, by = "state")
join$full_name <- tolower(join$full_name)
join <- join %>%
  # select(full_name, state, mean) %>%
  rename(region = full_name)
states <- merge(states, join, by = "region", all.x = T)
```


```{r map-HPI, fig.cap="The map of HPI in each state"}
statements <- states %>%
  group_by(state) %>%
  summarise(
    long = mean(range(long)), 
    lat = mean(range(lat)), 
    group = mean(group), 
    mean = mean(mean)
  )

ggplot(states, aes(x = long, y = lat, group = group, fill = mean)) + 
  geom_polygon(color = "white", show.legend = T) +
  scale_fill_gradient(name = "Percent", low = "#FFFBD5", high = "#B20A2C", guide = "colorbar", na.value = "black", breaks = pretty_breaks(n = 5)) +
  labs(title = "House Price Index in Each State in USA", x = "Longitude", y = "Latitude") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, size = 16)) +
  geom_text(data = statements, aes(x = long, y = lat, label = state), size = 3) +
  theme_bw()+
  # theme(panel.grid=element_blank(),panel.border=element_blank(),axis.line=element_line(size=1,colour="black"))+
  theme(axis.ticks.y = element_blank(), axis.text.y = element_blank()) +
  theme(axis.ticks.x = element_blank(), axis.text.x = element_blank()) +
  xlab(NULL) +
  ylab(NULL)
```


# Acknowledgments
The following packages are used to produce this report:
tidyverse [@tidyverse], lubridate [@lubridate], stringr [@stringr], kableExtra [@kableExtra], readxl [@readxl], rvest [@rvest], janitor [@janitor], dplyr [@dplyr] , plotly [@plotly], MASS[@MASS], scales[@scales], broom[@broom]

# References
