---
title: "ETC5521 Assignment 1"
subtitle: "House and Mortgage Data"
team: Dugong
author:
  - Abhishek Sinha
  - Yezi He
  - Yawen Zhang
  - Cuiping Wei
output: 
  bookdown::html_document2
bibliography: reference.bib
biblio-style: authoryear-comp
link-citations: yes
linestretch: 3
date: "`r Sys.Date()`"
output: 
  bookdown::html_document2: 
    toc: yes
    toc_float:
      collapsed: true
      number_sections: false
    theme: paper
---

[This assignment is for ETC5521 Assignment 1 by Team `r rmarkdown::metadata$team` comprising of `r knitr::combine_words(rmarkdown::metadata$author)`.]{style="color:#006DAE;"}

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,warning = FALSE,message = FALSE)
library(tidyverse)
library(scales)
library(lubridate)
library(broom)
library(MASS)
library(stringr)
library(kableExtra)
library(readxl)
library(janitor)
library(rvest)
library(dplyr)
library(plotly)
```

```{r write-data}
# state_hpi <- readr::read_csv("https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2019/2019-02-05/state_hpi.csv")
# mortgage_rates <- readr::read_csv("https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2019/2019-02-05/mortgage.csv")
# recession_dates <- readr::read_csv("https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2019/2019-02-05/recessions.csv")

# write_csv(state_hpi, here::here("data", "state_hpi.csv"))
# write_csv(mortgage_rates, here::here("data", "mortgage_rates.csv"))
# write_csv(recession_dates, here::here("data", "recession_dates.csv"))
```

```{r read-data}
state_hpi <-readr::read_csv(here::here("data/state_hpi.csv")) 
mortgage_rates<-readr::read_csv(here::here("data/mortgage_rates.csv")) 
recession_dates<-readr::read_csv(here::here("data/recession_dates.csv")) 
```


# Introduction and motivation

The House Price Index(HPI) is a broad index for calculating the monthly change in the selling prices of single-family house prices, which provides house price trends at various state and national levels [@index2018federal]. Also, the housing market represents about 15% to 18% of U.S. GDP[@2019national], which means a weak or strong housing market can substantially influence the direction of the overall economy.   
In recent years, as the U.S. housing market booming, HPI drew increasing attention from housing economists. From 1975 to 2018, the HPI went through ups and downs, especially the Great Depression that started in 2007, which led to the cold winter for the real estate market. What can we find from HPI when it comes to the mortgage rates? What's the story between HPI, mortgage rates, and the recession?   
It's exciting to explore what interesting economic secrets can HPI, mortgage rates, and the recession tell us?   

## Secondary research questions

- How similar is the change in state HPI with national HPI?  
- Do lower mortgage rates mean higher HPI? Can the long mortgage rates predict HPI?
- Can HPI and mortgage rates provide evidence of a sub-prime crisis?  
- Are HPI more likely to be higher in prosperous or populous cities?   
- Can we find any house price bubble in the U.S from 1975 to 2018?  
- Was the annual change for the HPI index similar to the mortgage rates?  

# Data description




# Analysis and findings


## Can HPI and mortgage rates provide evidence of a subprime crisis? 

```{r recession-wrangle}
# separate the period time to "start" and "end"
recession_dat <- recession_clean  %>% 
  separate(period_range, into = c("start", "end"), sep = "â€“") %>% 
  mutate(start = as.Date(parse_date_time(start, "%b %Y")), 
         end = as.Date(parse_date_time(end, "%b %Y"))) 

recession_tab <- recession_dat %>% 
  select(1:4,6) %>% 
  kable(caption = "Early recessions and crises") %>% 
  kable_styling()
recession_tab
```


```{r}
state_hpi <- state_hpi %>% 
  mutate(date = ymd(year*10000+month*100+1)) 

nation_hpi <- state_hpi %>%
  #mutate(date = ymd(year*10000+month*100+1)) %>% 
  dplyr::select("date","year","month","us_avg") %>%
  distinct()

```

```{r miss, fig.cap="Missing value for the mortgage rates, only available for fixed 30 years don't have NA"}
mortgage_rates %>%
  select(2,4,6) %>% 
  vis_miss()
```

Changes in HPI and mortgage rates are closely related to economic activity. However, is there a correlation with recessions? Analyzing the effect of the recession on HPI and mortgage rates using financial data is outside this report's scope. However, the recession data scripted from Wikipedia can give us insights to look at the behavior of HPI and mortgage rates during the period of recession.    

As a first step, we examined the missing value of the mortgage rate data. From Figure \@ref(fig: miss), we found that the mortgage rates for fixed 15 and adjustable 5-1 Hybrids were completely missing, so we only can use the mortgage rates for fixed 30 at the end.   

```{r state_abb_data}
# data of 2-letter abbreviations for the state names
state_abb <- as.data.frame(state.abb)
state_abb <- state_abb %>% mutate(region = state.region)
colnames(state_abb)[1] <- "state"

# join the state HPI data
state_hpi_abb <- merge(x=state_hpi, y=state_abb, by="state", all.x = TRUE)
state_hpi_abb$region[is.na(state_hpi_abb$region)] <- "South"

# divided HPI data into four regions, choose median represents region HPI
state_data_hpi <- state_hpi_abb %>% 
  dplyr::select("date", "region", "state", "price_index", "us_avg") %>% 
  group_by(date,region,us_avg) %>% 
  summarise(price_index = median(price_index))
```

```{r hpi-mort}
# national HPI
hpi_mort <- ggplot()+ 
  geom_line(data=mortgage_rates, 
            aes(x=date, y=fixed_rate_30_yr*10), 
            color="red") +
  geom_line(data=nation_hpi, 
            aes(x=date, y=us_avg), 
            color="green")+
  scale_y_continuous(sec.axis = sec_axis(~ . *0.1, name = "Mortgage Rates"))+
  xlim(ymd(19750101), NA) +
  labs(x="Date", y="US Average HPI") +
  ggtitle("HPI vs. Mortgage rates")

```

```{r nation_recession, fig.cap="The trend for Recession, National HPI and Mortgage rates. The red line represents the mortgage rates, the green line represents HPI, and the shaded blue area represents the duration of the recession."}
# combine national HPI and recession into one plot
mortgage_recession <- hpi_mort +
  geom_rect(data = recession_dat, 
            aes(xmin = start, xmax = end, ymin = -Inf, ymax = Inf), 
            alpha = 0.25, 
            fill = "blue") +
  ggtitle("Recession, HPI and Mortgage Rates")+
  theme_light()

mortgage_recession

```

Figure \@ref(fig: nation_recession) shows the trends for the U.S. average HPI and mortgage rates and the period time of recession across time in the U.S. as well. From Figure \@ref(fig: nation_recession), we can find that the HPI kept rising from 1975 to 2006, even as the American economy has experienced many recessions in this period, which may seem strange. It indicates that with the development of the economy, urban expansion, and population increase, people's demand for housing is increasing [@kulish2012urban]. However, the HPI had a significant drop between 2007 and 2009 during the Great Recession. The sub-prime mortgage crisis led to a sustained economic depression, with the unemployment rate reaching 10%, leading to a sharp reduction in demand for houses[@lee2013happens].   

When we turn our attention to the mortgage rates, we can find some different trends from the HPI. Interestingly, the mortgage rates experienced drastic fluctuations during the 1980 Recession and the 1981-1982 Recession, indicating an association between them. Also, the mortgage rates rose slightly and then decreased during the Great Recession from December 2007 to June 2009. From the above analysis, it can be seen that the mortgage rates tend to go through a process of rising and then falling during the economic recession, which was because the government used monetary policy to adjust interest rates and promote economic recovery[@azis2010predicting].   

## Can we find any house price bubble in the U.S from 1975 to 2018?

```{r bubble, fig.cap="Recession and National HPI. The occurrence of the US housing bubble from 1975 to 2018 and the scenarios that may present in the future."}
# bubble plot
p_bubble <- state_hpi %>% 
  ggplot() +
  geom_line(aes(date, us_avg), 
            color = "green") +
  geom_rect(data = recession_dat, 
            aes(xmin = start, xmax = end, ymin = -Inf, ymax = Inf), 
            alpha = 0.25, fill = "blue") +
  annotate("segment", 
           x=as.Date('2001-02-01'), 
           xend=as.Date('2012-01-01'), 
           y=100, yend=100, 
           colour = "red", 
           size = 0.6)+
  annotate("segment", 
           x=as.Date('2012-01-01'), 
           xend=as.Date('2023-09-01'), 
           y=120, yend=120, 
           colour = "red", 
           size = 0.6)+
  annotate("pointrange", 
           x = as.Date('2006-12-01'), 
           y = 166, 
           ymin = 100, ymax = 190, 
           colour = "red", 
           size = 0.6)+
  annotate("pointrange", 
           x = as.Date('2019-01-01'), 
           y = 190, 
           ymin = 120, ymax = 200, 
           colour = "red", 
           size = 0.6)+
  annotate("segment", 
           x = as.Date('2019-01-01'), 
           xend=as.Date('2025-09-01'), 
           y = 192, yend = 100, 
           colour = "#69b3a2", 
           size=1, alpha=1, 
           arrow=arrow())+
  annotate(geom = "text", 
           x=as.Date('2025-12-01'), 
           y=85, 
           label="Future\nscenario ?", 
           size = 4, 
           color = "red")+
  annotate(geom = "text", 
           x=as.Date('2006-12-01'), 
           y=90, 
           label="Bubble1", 
           size = 4, 
           color = "red")+
  annotate(geom = "text", 
           x=as.Date('2019-01-01'), 
           y=110, 
           label="Bubble2", 
           size = 4, 
           color = "red")+
  ggtitle("Recession, National HPI and Housing Bubble")+
  xlim(c(ymd(19750101),ymd(20261201))) +
  ylab("US Average HPI") +
  xlab("Date") +
  theme_light()

p_bubble
```


## Was the annual change for the HPI index similar to the mortgage rates?  

```{r mort-fixed30}
mortgage_fix30 <- mortgage_rates %>% 
  select(1:2) %>% 
  mutate(year = year(date)) %>% 
  filter(year >= 1975) %>% 
  group_by(year) %>% 
  summarise(fixed_30yr_avg = mean(fixed_rate_30_yr)) %>% 
  mutate(ratio = (fixed_30yr_avg - lag(fixed_30yr_avg)) / fixed_30yr_avg,
         ratio = round(ratio,3))

```

```{r nation-hpi-change}
nation_hpi_change <- nation_hpi %>% 
  group_by(year) %>% 
  summarise(us_avg = mean(us_avg)) %>% 
  mutate(ratio = (us_avg - lag(us_avg)) / us_avg,
         ratio = round(ratio,3))
  
```

```{r change, fig.cap="**Mortgage annual changes** VS **HPI annual changes**"}
p1<-mortgage_fix30 %>% 
  ggplot(aes(year, ratio)) + 
  geom_bar(aes(fill=factor((ratio>0)+1)),
           stat="identity")+
  scale_x_continuous(breaks = seq(1975,2020,6))+
  ggtitle("Mortgage annual changes")+
  # scale_fill_discrete(name="Change",
  #                        breaks=c("1", "2"),
  #                        labels=c("Down", "Up"))+
  scale_fill_manual("change",
                    breaks=c("1","2"), 
                    labels=c("Down", "Up"),
                    values=c("#FFAEB9","#7AC5CD"))+
  guides(fill = guide_legend(reverse=TRUE))+
  theme_light()

p2<-nation_hpi_change %>% 
  ggplot(aes(year, ratio)) + 
  geom_bar(aes(fill=factor((ratio>0)+1)),
           stat="identity") +
  scale_x_continuous(breaks = seq(1975,2020,6))+
  ggtitle("HPI annual changes")+
  # scale_fill_discrete(name="Change",
  #                        breaks=c("1", "2"),
  #                        labels=c("Down", "Up"))+
   scale_fill_manual("change", 
                     breaks=c("1","2"),
                     labels=c("Down", "Up"),
                    values=c("#FFAEB9","#7AC5CD"))+
  guides(fill = guide_legend(reverse=TRUE))+
  theme_light()

p1/p2+plot_layout(guides = "collect")

```


# Limitations of anaysis


# Conclusion


# Acknowledgments
The following packages are used to produce this report:
tidyverse [@tidyverse], lubridate [@lubridate], stringr [@stringr], kableExtra [@kableExtra], readxl [@readxl], rvest [@rvest], janitor [@janitor], dplyr [@dplyr] , plotly [@plotly], MASS[@mass], scales[@scales], broom[@broom]

# References
