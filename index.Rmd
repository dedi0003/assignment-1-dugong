---
title: "ETC5521 Assignment 1"
subtitle: "House and Mortgage Data"
team: Dugong
author:
  - Abhishek Sinha
  - Yezi He
date: "`r Sys.Date()`"
output: 
  html_document
---

[This assignment is for ETC5521 Assignment 1 by Team `r rmarkdown::metadata$team` comprising of `r knitr::combine_words(rmarkdown::metadata$author)`.]{style="color:#006DAE;"}


# Introduction and motivation

House Price Index (HPI) is a broad measure to understand the movement of the single-family house prices across a designated market. HPI provides housing economists with an improved analytical tool that is useful for estimating changes in the rates of mortgage defaults, prepayments and housing affordability in specific geographic areas. Economists and Fund Managers often use HPI to analyse long term trends in consumer behaviour and financial situation of the country. It is for this exact reason currency investors keep a watch on HPI along with Consumer Price Index (CPI), Gross Domestic Product (GDP) and unemployment figures. Experts say that HPI can predict inflation. With proper lender assistance, HPIs can also help you decide if it’s a good time to purchase a new home.   

The housing market represents about 15 percent to 18 percent of U.S. GDP, which means a weak or strong housing market can have substantial influence on the direction of the overall economy. This makes HPI even more important to track and use in analysis.   

The motivation of this report is to analyse the House Price Index in the U.S. overtime and also detailed it down to some prominent states. The report will also analyse the effect of the external factors like recession and mortgage rates on HPI.   

At present, the House Price Index is a relatively less known economic indicator which is soon gaining popularity among economists. Although this report is limited to establish HPI’s as an alternative economic factor to understand recession and its relation with mortgage rates, analysing HPI in greater detail will allow for more informative view of the state of an economy and HPI’s relation with other factors like Currency fluctuation and GDP. As the strength of housing market also dictates the state of the workforce involved in this sector, relating HPI with population and workforce data will provide another interesting relation to analyse and predict the state of workforce and income during recessions.  

# Data description

In order to perform this analysis a real time data source is used to get an updated information for the HPI values which is also seasonally adjusted along with an updated mortgage rates. In this case it is Freddie Mac. To get information about the prominent recession period in the U.S., web scrapping is used to scrape data from wikipedia.  

### Freddie Mac House Price Index   

In the U.S., the House Price Index is published by the Federal Housing Finance Agency (FHFA), using data supplied by the Federal National Mortgage Association (FNMA), typically known as Fannie Mae, and Federal Home Loan Mortgage Corp. (FHLMC), commonly known as Freddie Mac.   

Freddie Mac publishes the monthly index values of the Freddie Mac House Price Index (FMHPI) each quarter. Index values are available for the nation, the 50 states and the District of Columbia, and the more than 380 metropolitan statistical areas (MSAs) in the U.S. The FMHPI is constructed using a repeat transactions methodology, which has become a common practice in housing research. The FMHPI is estimated with data including transactions on single-family detached and townhome properties serving as collateral on loans originated between January 1, 1975, and the end of the most recent index month, where the loan has been purchased by Freddie Mac or Fannie Mae.  

Repeat transactions indices measure price appreciation while holding constant property type and location, by comparing the price of the same property over two or more transactions. By construction, therefore, the repeat transaction requirement excludes new homes. The change in price of a given property measures the underlying rate of appreciation because basic factors such as physical location, climate, housing type, etc., are constant between transactions.   

Significant renovation or deterioration to a property may, however, lead to higher or lower appreciation, respectively, than what results from the underlying price change of the property as it existed in the first transaction. The methodology attempts to identify and exclude such outlier properties that may influence the index away from a more accurate estimate of average property appreciation rates.  

Further the calculation of HPI also involves appraisal values for some refinance decisions. Refinance adjustment terms are included in the regression specification to account for the possibility that appraisal values might systematically differ from purchase prices. These additional transactions greatly increase the power of estimation, especially at smaller levels of geography.   

Thus the primary differences between the FMHPI and other indices are the inclusion of some appraisal values used for refinance transactions, the choice of geographic weights, the method for identifying outliers, and the use of statistical smoothing to more efficiently estimate indices at finer geographic levels.   

The HPI (or FMHPI) SA raw dataset, consists of both state level HPI and national HPI in a xls format. To use it for analysis in R, which is the preferred tool for analysis in this report, the raw data is further cleaned by breaking variable like month into two seperate variables year and month, updating datatypes and removing data with missing year. This dataset has been maintained by Freddie Mac from January’1975 onwards. For this report the data is taken till November’2018.  

### Mortgage Rates:

The second dataset is of Freddie Mac’s Mortgage rates. Mortgage rates are an important factor that can influence the home buyer's decision. Freddie Mac maintains an extensive dataset for mortgage rates consisting of different types of mortgage like ‘Fixed rate 30 year mortgage’ , ‘Fixed rate 15 year mortgage’ and ‘5-1 Hybrid Adjustable rate mortgage’. Analysing mortgage rates for HPI is also important they are the most common type of personal loan held by households. In other words, Buying a home with a mortgage is probably the largest financial transaction you will enter into.   

Mortgage rates are mainly of two types, fixed and adjustable. Fixed rate mortgage is a fixed interest rate loan whereas interest rates changes under defined conditions in adjustable or hybrid loan.  

Fixed-Rate Mortgage:
The monthly payment remains the same for the life of this loan. The interest rate is locked in and does not change. Loans have a repayment life span of 30 years; shorter lengths of 10, 15 or 20 years are also commonly available. Shorter loans will have larger monthly payments that are offset by lower interest rates and lower overall cost.   

Adjustable-Rate Mortgage (ARM):
Because the interest rate is not locked in, the monthly payment for this type of loan will change over the life of the loan. ARMs can be attractive if you are planning on staying in your home for only a few years. It is important to consider how often the interest rate will adjust. For example, a five-to-one-year ARM has a fixed rate for five years, then every year the interest rate will adjust for the remainder of the loan period.  

This dataset has been maintained by Freddie Mac from April’1971 onwards. Freddie Mac has surveyed lenders across the nation weekly to determine the average 30-year fixed-rate mortgage rate; in 1984, the 1-year ARM was added to the survey and the 15-year fixed-rate mortgage rate was included beginning in 1991. In January 2005, Freddie Mac added a 5/1 hybrid ARM series to the survey. Survey reminder emails are sent out on Mondays and lenders are asked to respond by close of business Wednesday.  

### Recession: 

The final dataset is a dataset created with information scrapped from wikipedia on major recession periods in US like the Great Recession in 2007. These events had some major effects across many industries and markets and are an important factor in analysing the house prices overtime. Recession can slow down the market, increase unemployment which leads to loss of income and falling wages which ultimately reduces the spending power of potential home buyers.  

# Analysis and findings

In our study, we want to figure out what factors can affect House Price Index (HPI) and how they affect HPI. We get the final answer by analyzing three questions. The first is the relationship between mortgage rates and HPI. The second question is how the recession affected HPI. The third question is how the HPI value of the state is related to the HPI value of the country.

[FILL] Should include at least one plot or numerical summary for each of your questions, that helps the reader arrive at an answer. You should also write paragraphs describing the methods, summaries and findings. 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,warning = FALSE,message = FALSE)
library(tidyverse)
library(scales)
library(lubridate)
library(broom)
library(MASS)
library(stringr)
library(kableExtra)
library(readxl)
library(janitor)
library(rvest)
library(dplyr)
```

```{r state_abbr, cache=TRUE, echo=FALSE}
# Download file in working directory
#destfile = "State_and_US_SA.xls"
#curl::curl_download(url = "http://www.freddiemac.com/fmac-resources/research/docs/State_and_US_SA.xls", 
#                    destfile = destfile)
```

### HPI data

```{r HPI-data, warning=FALSE, message=FALSE, echo=FALSE}
data_hpi <- read_excel("State_and_US_SA.xls", skip = 5) %>% 
  separate(Month, c("year", "month"), sep = "M") %>% 
  mutate_at(vars(year, month), as.integer) %>% 
  filter(!is.na(year)) %>%
  gather(state, price_index, AK:WY) %>% 
  rename(us_avg = `United States seasonally adjusted`) %>% 
  mutate(price_index = as.numeric(price_index))

head(data_hpi)
```

### Mortgage Data

```{r message=FALSE,warning=FALSE, echo=FALSE}
data_mortage <- read_excel("historicalweeklydata.xls", skip = 6, sheet = 2,
                  col_types = "numeric") %>% 
  set_names(nm = c("date", "fixed_rate_30_yr", "fees_and_pts_30_yr", 
                   "fixed_rate_15_yr",
                   "fees_and_pts_15_yr", "adjustable_rate_5_1_hybrid", 
                   "fees_and_pts_5_1_hybrid", "adjustable_margin_5_1_hybrid", 
                   "spread_30_yr_and_fixed_5_1_adjustable", "delete")) %>% 
  mutate(date = as.Date(date, origin = "1899-12-30"))

head(data_mortage)
```

### Recession Data

```{r read-recession-data, warning=FALSE, message=FALSE, echo=FALSE}
url <- "https://en.wikipedia.org/wiki/List_of_recessions_in_the_United_States"

df3 <- url %>% 
  read_html() %>% 
  html_table() %>% 
  .[[3]] %>% 
  janitor::clean_names()

recession_data <- df3 %>% 
  mutate(duration_months = substring(duration_months, 3),
         period_range = substring(period_range, 5),
         time_since_previous_recession_months = substring(time_since_previous_recession_months, 4),
         period_range = case_when(name == "Great Depression" ~ "Aug 1929-Mar 1933",
                                  name == "Great Recession" ~ "Dec 2007-June 2009",
                                  TRUE ~ period_range))

head(recession_data)
```

```{r wrangle, echo=FALSE}
mortgage_rates <-  data_mortage %>%
  dplyr::select("date","fixed_rate_30_yr")

mortgage_rates_month <-  mortgage_rates %>%
  mutate(year = year(date), month = month(date)) %>%
  dplyr::select("date","year","month","fixed_rate_30_yr") %>%
  group_by(year,month) %>%
  summarise("mortgage rates" = mean(fixed_rate_30_yr))

state_hpi <- data_hpi %>% 
  mutate(date = ymd(year*10000+month*100+1)) 

nation_hpi <- state_hpi %>%
  dplyr::select("date","year","month","us_avg") %>%
  distinct()

```


## National HPI

Generally, the trend of United States national HPI is showen below. 


```{r hpi-date}
# how to show the peak of this graph
hpi_date <- nation_hpi %>%
  ggplot(aes(date, us_avg)) +
  geom_line(color = "green") +
  xlab("Date") +
  ylab("US Average HPI") +
  ggtitle("US Average HPI")
hpi_date
```

```{r}
state_abb <- as.data.frame(state.abb)
state_abb <- state_abb %>% mutate(region = state.region)
colnames(state_abb)[1] <- "state"
state_abb

state_hpi_abb <- merge(x=state_hpi, y=state_abb, by="state", all.x = TRUE)
state_hpi_abb$region[is.na(state_hpi_abb$region)] <- "South"


state_data_hpi <- state_hpi_abb %>% dplyr::select("date", "region", "state", "price_index", "us_avg") %>% group_by(date,region) %>% summarise(price_index = median(price_index))

state_data_hpi %>%
  ggplot(aes(date, price_index)) +
  geom_line(color = "red") + 
  facet_wrap( ~ region) +
  xlab("Date") +
  ylab("US Region Average HPI") +
  ggtitle("US Region wise Average HPI")
```

## Mortgage

As the plot shows below the mortgage rates and US national HPI. There seems no significant relationship. But when the HPI or mortgage rates are very high, the another one will decline.

```{r p1-hpi-mort}
p1_hpi_mort <- ggplot()+ 
  geom_line(data=mortgage_rates, aes(x=date, y=fixed_rate_30_yr*10), color="red") +
  geom_line(data=nation_hpi, aes(x=date, y=us_avg), color="green")+
  scale_y_continuous(sec.axis = sec_axis(~ . *0.1, name = "Mortgage Rates"))+
  scale_x_date(labels = date_format("%Y"), breaks = date_breaks("10 year")) +
  xlim(ymd(19750101), NA) +
  labs(x="Date", y="US Average HPI") +
  ggtitle("HPI vs. Mortgage rates")
p1_hpi_mort
```

Also we build a rlm model to find their relationship, but it seems not fit very well. It may because the high value of mortgage rates.

```{r rlm}
hpi_mort <- merge(nation_hpi, mortgage_rates_month, by = c("year","month")) %>%
  arrange(date) %>%
  dplyr::select(-year, -month)
hpi_mort %>% 
  ggplot(aes(`mortgage rates`, us_avg)) +
  geom_point() +
  geom_smooth(method = "rlm", se = FALSE) +
  ggtitle("Robust linear model for mortgage rate and HPI")
hpi_mort_rlm <- rlm(us_avg ~ lag(`mortgage rates`), data = hpi_mort)
summary(hpi_mort_rlm)
```

## Recession

```{r recession-wrangle}
# modify typical value of recession_dates
recession_dates$period_range[1] <- "1929Aug 1929-Mar 1933"
recession_dates$period_range[14] <- "2007Dec 2007-June 2009"
# mutate "from" and "to" columns
recession_dates1 <- recession_dates  %>% 
  mutate(from_c = word(recession_dates$period_range,1,1,sep = "-"), 
         to_c = word(recession_dates$period_range,2,2,sep = "-")) %>%
     mutate(from_c = substring(from_c,5))   %>%
  mutate(from = as.Date(parse_date_time(from_c, "%b %Y")), 
         to = as.Date(parse_date_time(to_c, "%b %Y"))) %>%
  dplyr::select("name", "from","to") 
```

```{r recession-kable}
kable(recession_dates1) %>%
  kable_styling(bootstrap_options = "basic", position = "center")
```

```{r p2-hpi-recession}
p2_hpi_recession <- nation_hpi %>% 
  ggplot() +
  geom_line(aes(date, us_avg), color = "green") +
  geom_rect(data = recession_dates1, aes(xmin = from, xmax = to, ymin = -Inf, ymax = Inf), alpha = 0.25, fill = "blue") +
  xlim(ymd(19750101), NA) +
  ylab("US Average HPI") +
  xlab("Date") +
  ggtitle("Recession and US Average HPI")
p2_hpi_recession
```

If we add the mortgage rates on this plot, it is clear that 1980 Recession and 1981-1982 Recession have a strong connection to the mortgage rates in this period.

```{r p3_mortgage_recession}
p3_mortgage_recession <- p1_hpi_mort +
  geom_rect(data = recession_dates1, aes(xmin = from, xmax = to, ymin = -Inf, ymax = Inf), alpha = 0.25, fill = "blue") +
  ggtitle("Recession, HPI and Mortgage Rates")

p3_mortgage_recession
```


## States and the Nation

```{r national-diff}
# the difference of national HPI
national_diff <- max(nation_hpi$us_avg)-min(nation_hpi$us_avg)
```

We have calculated the difference of national maximun HPI and national minimun HPI, which is `r round(national_diff)`. And then we find the states whose differences are 1.25 times the national HPI difference as below. In the following analysis we will focus on these four states.

```{r difference}
# filter the states whose differences are 1.25 times the national HPI difference
state_hpi_diff <- state_hpi %>%
  group_by(state) %>%
  mutate(max = max(price_index),
         min = min(price_index),
         difference = max-min) %>%
  filter(difference > national_diff*1.25)
# show them by a kable
distinct(state_hpi_diff,state,difference) %>%
  arrange(difference) %>%
  kable() %>%
  kable_styling(bootstrap_options = "basic", position = "center")
```


```{r state-hpi}
state_hpi1 <- state_hpi%>%
  filter(state %in% c("WA","CA","HI","DC"))
  
state_hpi1 %>%  
  ggplot() +
  geom_line(aes(date,price_index,group = state)) +
  facet_wrap( ~ state) +
  xlab("Date") +
  ylab("State HPI") +
  ggtitle("HPI of four states")
  

state_hpi1 %>% 
  ggplot(aes(price_index, us_avg)) +
  geom_point() +
  facet_wrap( ~ state) +
  geom_smooth(method = "lm", se = FALSE) +
  xlab("States HPI") +
  ylab("US Average HPI")
  ggtitle("Linear model for state HPI and national HPI")
```



# References
