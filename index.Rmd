---
title: "ETC5521 Assignment 1"
subtitle: "House and Mortgage Data"
team: Dugong
author:
  - Abhishek Sinha
  - Yezi He
date: "`r Sys.Date()`"
output: 
  html_document
---

[This assignment is for ETC5521 Assignment 1 by Team `r rmarkdown::metadata$team` comprising of `r knitr::combine_words(rmarkdown::metadata$author)`.]{style="color:#006DAE;"}


# Introduction and motivation

[FILL] Give the bigger picture of the data, and inspire the reader to learn more about the problem by reading your analysis. 

In our study, we want to figure out what factors can affect House Price Index (HPI) and how they affect HPI. We get the final answer by analyzing three questions. The first is the relationship between mortgage rates and HPI. The second question is how the recession affected HPI. The third question is how the HPI value of the state is related to the HPI value of the country.

# Data description

House and Mortgage Data consists of three separate data tables from different sources. These tables are:

1. **House Price Index**: The data for House Price Index (HPI) has been originally taken from ‘Freddie Mac’ website (http://www.freddiemac.com/research/indices/house-price-index.page). The raw data is then further modified to include 26,877 observations and 5 variables. These variables are:  

**Year**: A date-integer type variable with year information.  
**Month**: A date-integer type variable with months information.  
**State**: A character data type variable with US state’s abbreviations.  
**price_index**: A double data type variable with the calculated values for HPI at state level.  
**us_avg**: A double data type variable with the calculated values for HPI at national level.  

This dataset has been maintained by Freddie Mac from January’1975 onwards. This particular dataset has data till November’2018 and is a monthly data for every US state with calculated values for HPI at State level & national level. The price_index at state level and national level is calculated using a repeat-transactions methodology. For calculating HPI, Freddie Mac uses a dataset that includes valuation and location data for the combined portfolio of loans that were purchased by either Freddie Mac or Fannie Mae since January 1975. This dataset is updated monthly with new purchases from the two firms.

2.	**Mortgage Rates**: The data for Mortgage Rates has been taken from Freddie Mac’ website (http://www.freddiemac.com/pmms/). The dataset consists of 2492 observations and 9 variables. These variables are:  

**Date**: A date type variable with dates.  
**Fixed_rate_30_yr**: A double datatype with 30-year fixed rate mortgage in percent  
**Fees_and_pts_30_yr**: A double datatype with fees and percentage points of the loan amount  
**Fixed_rate_15_yr**: A double datatype with 15-year fixed rate mortgage in percent  
**Fees_and_pts_15_yr**: A double datatype with fees and percentage points of the loan amount  
**Adjustable_rate_5_1_hybrid**: A double datatype with adjustable mortgage rate based on 5-1 hybrid i.e. 5 year fixed, then annual adjustable rate.  
**Fees_and_pts_5_1_hybrid**: A double datatype with fees and percentage points of the loan amount  
**Adjustable_margin_5_1_hybrid**: A double datatype variable. This variable represents a full index rate for an ARM with a fixed amount added to the initial index.  
**Spread_30_yr_fixed_and_5_1_adjustable**: A double datatype with difference between 30-year fixed rate and 5-1 adjustable rate  

This dataset has been maintained by Freddie Mac from April’1971 onwards. Freddie Mac has surveyed lenders across the nation weekly to determine the average 30-year fixed-rate mortgage rate; in 1984, the 1-year ARM was added to the survey and the 15-year fixed-rate mortgage rate was included beginning in 1991. In January 2005, Freddie Mac added a 5/1 hybrid ARM series to the survey. Survey reminder emails are sent out on Mondays and lenders are asked to respond by close of business Wednesday. 

3.	**Recession Dates**: The final dataset is a dataset created with information on major recession periods in US like the Great Recession in 2007. These events had some major effects across many industries and markets and are an important factor in analysing the house prices overtime. The information has been scrapped from Wikipedia (https://en.wikipedia.org/wiki/List_of_recessions_in_the_United_States).
The dataset consists of 14 observations of 7 variables. These variables are:  

**Name**: A character datatype variable with recession names.  
**Period_range**: A character datatype variable defining the range or period of the recession.  
**Duration_months**: A character datatype variable with recession period in months.  
**Time_since_previous_recession_months**: A character datatype variable with information about time since previous recession in months.  
**Peak_unemploy_ment**:  A character datatype variable with information on the peak unemployment in percent.  
**Gdp_decline_peak_to_trough**: A character datatype variable that defines the GDP decline from peak.  
**Characteristics**: A character datatype variable that give a description about the recession.  

# Analysis and findings

[FILL] Should include at least one plot or numerical summary for each of your questions, that helps the reader arrive at an answer. You should also write paragraphs describing the methods, summaries and findings. 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,message = FALSE)
library(tidyverse)
library(scales)
library(lubridate)
library(broom)
library(MASS)
library(kableExtra)
library(patchwork)
```

```{r read-data}
state_hpi <- readr::read_csv("https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2019/2019-02-05/state_hpi.csv")
mortgage_rates <- readr::read_csv("https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2019/2019-02-05/mortgage.csv")
recession_dates <- readr::read_csv("https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2019/2019-02-05/recessions.csv")

```

```{r wrangle}
mortgage_rates <-  mortgage_rates %>%
  dplyr::select("date","fixed_rate_30_yr")

mortgage_rates_month <-  mortgage_rates %>%
  mutate(year = year(date), month = month(date)) %>%
  dplyr::select("date","year","month","fixed_rate_30_yr") %>%
  group_by(year,month) %>%
  summarise("mortgage rates" = mean(fixed_rate_30_yr))

state_hpi <- state_hpi %>% 
  mutate(date = ymd(year*10000+month*100+1)) 

nation_hpi <- state_hpi %>%
  dplyr::select("date","year","month","us_avg") %>%
  distinct()
```

## National HPI

Generally, the trend of United States national HPI is showen below. 


```{r hpi-date}
# how to show the peak of this graph
hpi_date <- nation_hpi %>%
  ggplot(aes(date, us_avg)) +
  geom_line(color = "green") +
  xlab("Date") +
  ylab("US Average HPI")
hpi_date
```

## Mortgage

As the plot shows below the mortgage rates and US national HPI. There seems no significant relationship. But when the HPI or mortgage rates are very high, the another one will decline.

```{r p1-hpi-mort}
p1_hpi_mort <- ggplot()+ 
  geom_line(data=mortgage_rates, aes(x=date, y=fixed_rate_30_yr*10), color="red") +
  geom_line(data=nation_hpi, aes(x=date, y=us_avg), color="green")+
  scale_y_continuous(sec.axis = sec_axis(~ . *0.1, name = "Mortgage Rates"))+
  scale_x_date(labels = date_format("%Y"), breaks = date_breaks("10 year")) +
  labs(x="Date", y="US Average HPI") +
  ggtitle("HPI vs. Mortgage rates")
p1_hpi_mort
```

Also we build a rlm model to find their relationship, but it seems not fit very well. It may because the high value of mortgage rates.

```{r lm}
hpi_mort <- merge(nation_hpi, mortgage_rates_month, by = c("year","month")) %>%
  arrange(date) %>%
  dplyr::select(-year, -month)
hpi_mort %>% 
  ggplot(aes(`mortgage rates`, us_avg)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE)
hpi_mort_rlm <- rlm(us_avg ~ lag(`mortgage rates`), data = hpi_mort)
summary(hpi_mort_rlm)
```

## Recession



# References
